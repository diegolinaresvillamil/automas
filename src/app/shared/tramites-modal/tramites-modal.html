<!-- ‚úÖ HTML CON STEP 3 ELIMINADO -->
<div class="tramite-backdrop" *ngIf="open" (click)="cerrarModal()">
  <div class="tramite-modal" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="cerrarModal()">‚úï</button>

    <!-- ========================================= -->
    <!-- STEP 1: Seleccionar Tr√°mite -->
    <!-- ========================================= -->
    <div *ngIf="step === 1" class="tramite-container">
      <h2 class="tramite-title">Elige tu tr√°mite vehicular</h2>
      <p class="tramite-subtitle">
        Selecciona el servicio que deseas realizar y contin√∫a con el proceso
      </p>

      <div class="tramite-grid">
        <div
          *ngFor="let tramite of tramites"
          class="tramite-card"
          [class.active]="tramiteSeleccionado?.title === tramite.title"
          (click)="seleccionarTramite(tramite)"
        >
          <img [src]="tramite.icon" [alt]="tramite.title" class="tramite-icon" />
          <span class="tramite-label">{{ tramite.title }}</span>
        </div>
      </div>

      <p *ngIf="mostrarError" class="tramite-error">
        ‚ö†Ô∏è Por favor selecciona un tr√°mite para continuar
      </p>

      <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
        <button class="btn-outline" (click)="cerrarModal()">Cancelar</button>
        <button class="btn-primary" (click)="continuarAStep2()">Continuar ‚Üí</button>
      </div>
    </div>

    <!-- ========================================= -->
    <!-- STEP 2: Fecha y Horario -->
    <!-- ========================================= -->
    <div *ngIf="step === 2" class="modal-backdrop">
      <div class="modal-container modal-wide">
        <button class="close-btn" (click)="volverStep()">‚úï</button>

        <div class="tarifas-grid">
          <div class="col-izquierda">
            <div class="tarifas-header">
              <h2>Elige d√≥nde y cu√°ndo<br><strong>hacer tu tr√°mite</strong></h2>
              <p>
                Elegiste el tr√°mite <strong>Preliquidaci√≥n {{ tramiteSeleccionado?.title }}</strong>, 
                ahora elige la fecha para continuar.
              </p>
            </div>

            <div class="filtros">
              <div class="campo">
                <label for="tramite">Tr√°mite</label>
                <input
                  id="tramite"
                  type="text"
                  [value]="'Preliquidaci√≥n ' + (tramiteSeleccionado?.title || '')"
                  readonly
                  class="input-fecha"
                  style="background: #f5f5f5; cursor: not-allowed;"
                />
              </div>

              <div class="campo">
                <label for="fecha">Fecha</label>
                <input
                  id="fecha"
                  type="date"
                  [(ngModel)]="fechaSeleccionada"
                  (change)="onFechaChange()"
                  [min]="fechaMinima"
                  class="input-fecha"
                />
              </div>
            </div>

            <div class="campo" style="margin-top: 1rem;">
              <label for="franja">Horario disponible</label>
              <select
                id="franja"
                [(ngModel)]="franjaSeleccionada"
                [disabled]="franjas.length === 0"
                class="input-fecha"
              >
                <option value="">Selecciona un horario</option>
                <option *ngFor="let franja of franjas" [value]="franja">{{ franja }}</option>
              </select>
            </div>

            <p *ngIf="errorMessage" class="tramite-error">‚ö†Ô∏è {{ errorMessage }}</p>
            <p *ngIf="loading" class="loading-text">
              <i class="bi bi-hourglass-split"></i> Cargando...
            </p>
          </div>

          <div class="col-derecha">
            <div class="tarifa-card">
              <h3>üìã Resumen</h3>
              <p><strong>Tr√°mite:</strong><br>Preliquidaci√≥n {{ tramiteSeleccionado?.title }}</p>
              <p *ngIf="fechaSeleccionada"><strong>Fecha:</strong><br>{{ fechaSeleccionada }}</p>
              <p *ngIf="franjaSeleccionada"><strong>Horario:</strong><br>{{ franjaSeleccionada }}</p>
              
              <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">üí∞ Valor:</p>
                <p style="font-size: 2rem; font-weight: 700; color: #00a0b6; margin: 0;">
                  ${{ PRECIO_PRELIQUIDACION.toLocaleString('es-CO') }}
                </p>
                <p style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                  <i class="bi bi-clock"></i> Tiempo estimado: 1 hora
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
          <button class="btn-outline" (click)="volverStep()">‚Üê Volver</button>
          <button class="btn-primary" (click)="continuarAStep3()">Continuar ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- ========================================= -->
    <!-- STEP 3: Confirmaci√≥n CON FORMULARIO EDITABLE -->
    <!-- ========================================= -->
    <div *ngIf="step === 3" class="modal-backdrop">
      <div class="modal-container modal-wide">
        <button class="close-btn" (click)="volverStep()">‚úï</button>

        <div class="tarifas-grid">
          <!-- Columna izquierda -->
          <div class="col-izquierda">
            <div class="tarifas-header">
              <h2>¬°Confirma tu<br><strong>agendamiento!</strong></h2>
              <p>
                Has agendado el tr√°mite <strong>Preliquidaci√≥n {{ tramiteSeleccionado?.title }}</strong> 
                para el <strong>{{ fechaSeleccionada }}</strong> en la sede 
                <strong>{{ proveedorSeleccionado?.name || 'AutoM√°s Fontib√≥n' }}</strong>.
              </p>
              <p style="margin-top: 1rem; font-weight: 600;">
                Por favor, completa los siguientes datos para finalizar tu solicitud.
              </p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
              <div class="campo">
                <label>N√∫mero de placa</label>
                <input
                  type="text"
                  [(ngModel)]="formData.placa"
                  placeholder="Ej: ABC123"
                  maxlength="6"
                  class="input-fecha"
                  style="text-transform: uppercase;"
                />
              </div>

              <div class="campo">
                <label>Nombre completo del vendedor (propietario actual)</label>
                <input
                  type="text"
                  [(ngModel)]="formData.nombres"
                  placeholder="Ej: Juan P√©rez"
                  class="input-fecha"
                />
              </div>

              <div class="campo">
                <label>Tel√©fono</label>
                <input
                  type="tel"
                  [(ngModel)]="formData.celular"
                  placeholder="Ej: 3001234567"
                  maxlength="10"
                  class="input-fecha"
                />
              </div>

              <div class="campo">
                <label>Correo electr√≥nico</label>
                <input
                  type="email"
                  [(ngModel)]="formData.correo"
                  placeholder="Ej: correo@ejemplo.com"
                  class="input-fecha"
                />
              </div>

              <div class="campo">
                <label>Selecciona el tipo de documento del vendedor (propietario actual)</label>
                <select [(ngModel)]="formData.tipo_identificacion" class="input-fecha">
                  <option value="Cedula de Ciudadania">C√©dula de Ciudadan√≠a</option>
                  <option value="Cedula de Extranjeria">C√©dula de Extranjer√≠a</option>
                  <option value="Pasaporte">Pasaporte</option>
                </select>
              </div>

              <div class="campo">
                <label>Ingresa el n√∫mero de documento del vendedor (propietario actual)</label>
                <input
                  type="text"
                  [(ngModel)]="formData.identificacion"
                  placeholder="Ej: 1234567890"
                  class="input-fecha"
                />
              </div>

              <!-- ‚úÖ NUEVOS CAMPOS DEL COMPRADOR -->
              <div class="campo">
                <label>Selecciona el tipo de documento del comprador</label>
                <select [(ngModel)]="formData.tipo_identificacion_comprador" class="input-fecha">
                  <option value="">Selecciona tipo</option>
                  <option value="Cedula de Ciudadania">C√©dula de Ciudadan√≠a</option>
                  <option value="Cedula de Extranjeria">C√©dula de Extranjer√≠a</option>
                  <option value="Pasaporte">Pasaporte</option>
                  <option value="NIT">NIT</option>
                </select>
              </div>

              <div class="campo">
                <label>Ingresa el n√∫mero de documento del comprador</label>
                <input
                  type="text"
                  [(ngModel)]="formData.identificacion_comprador"
                  placeholder="Ej: 1234567890"
                  class="input-fecha"
                />
              </div>
            </div>

            <p *ngIf="errorMessage" class="tramite-error" style="margin-top: 1rem;">
              ‚ö†Ô∏è {{ errorMessage }}
            </p>
            <p *ngIf="loading" class="loading-text" style="margin-top: 1rem;">
              <i class="bi bi-hourglass-split"></i> Confirmando agendamiento...
            </p>

            <div class="botones-navegacion" style="margin-top: 2rem;">
              <button class="btn-outline" (click)="volverStep()">‚Üê Volver</button>
              <button class="btn-primary btn-success" (click)="confirmarAgendamiento()" [disabled]="loading">
                Confirmar Tr√°mite
              </button>
            </div>
          </div>

          <!-- Columna derecha -->
          <div class="col-derecha">
            <div class="ciudad-ubicacion">
              <i class="bi bi-geo-alt-fill"></i>
              <span>{{ ciudadSeleccionada?.name || 'Bogot√°' }} - {{ proveedorSeleccionado?.name || 'AutoM√°s Fontib√≥n' }}</span>
            </div>

            <div class="tarifa-card">
              <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #111520;">
                Tr√°mite - {{ tramiteSeleccionado?.title }}
              </h3>

              <div style="text-align: center; padding: 1.5rem 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                <p style="font-size: 0.85rem; color: #666; margin: 0 0 0.5rem 0;">Costo de:</p>
                <p style="font-size: 2.5rem; font-weight: 700; color: #00a0b6; margin: 0; line-height: 1;">
                  ${{ (cotizacion?.price || PRECIO_PRELIQUIDACION).toLocaleString('es-CO') }}
                </p>
              </div>

              <p style="font-size: 0.75rem; color: #888; margin-top: 1rem; text-align: center; line-height: 1.4;">
                Por favor verifica todos los datos antes de agendar*
              </p>

              <button class="btn-outline" style="margin-top: 1rem; font-size: 0.9rem;" 
                      (click)="verCondiciones()">
                Condiciones del Tr√°mite
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>