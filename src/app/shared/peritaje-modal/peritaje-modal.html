<div class="modal-backdrop" *ngIf="open()">
  <div class="peritaje-modal" role="dialog" aria-modal="true">
    <button class="close-btn" (click)="cerrar()" aria-label="Cerrar">√ó</button>

<!-- ===================== PASO 1 ===================== -->
<section *ngIf="paso() === 1" class="hero">
  <div class="hero-inner">
    <h2 class="kicker">Consulta y agenda</h2>
    <h1 class="title">tu <strong>Peritaje & Aval√∫o</strong></h1>

    <p class="subtitle">
      Con tu placa y documento verificaremos qu√© planes de peritaje est√°n disponibles para tu veh√≠culo.
      As√≠ podr√°s comparar beneficios, precios y elegir f√°cilmente el que mejor se adapte a tu necesidad.
    </p>

    <!-- ‚úÖ Mensaje de error si hay (consulta RUNT) -->
    <div class="alert alert-danger" *ngIf="errorRunt()">
      <strong>‚ö†Ô∏è Error:</strong> {{ errorRunt() }}
    </div>

    <form [formGroup]="form" class="form-grid" (ngSubmit)="consultar()">
      
      <!-- ‚úÖ PLACA con validaci√≥n -->
      <div class="campo">
        <label>N√∫mero de placa <span class="required">*</span></label>
        <input
          type="text"
          formControlName="placa"
          placeholder="ABC123"
          maxlength="6"
          (input)="onPlacaInput($event)"
          [class.error]="placaError"
        />
        <small class="error-message" *ngIf="placaError">{{ placaError }}</small>
      </div>

      <!-- ‚úÖ NOMBRE con validaci√≥n -->
      <div class="campo">
        <label>Nombre <span class="required">*</span></label>
        <input
          type="text"
          formControlName="nombre"
          placeholder="Nombre completo"
          (input)="onNombreInput($event)"
          [class.error]="nombreError"
        />
        <small class="error-message" *ngIf="nombreError">{{ nombreError }}</small>
      </div>

      <!-- ‚úÖ TEL√âFONO con validaci√≥n -->
      <div class="campo">
        <label>Tel√©fono <span class="required">*</span></label>
        <input
          type="text"
          formControlName="telefono"
          placeholder="321 321 3214"
          maxlength="10"
          (input)="onTelefonoInput($event)"
          [class.error]="telefonoError"
        />
        <small class="error-message" *ngIf="telefonoError">{{ telefonoError }}</small>
      </div>

      <!-- ‚úÖ TIPO DE DOCUMENTO -->
      <div class="campo">
        <label>Tipo de Documento del propietario <span class="required">*</span></label>
        <select formControlName="docTipo">
          <option value="cc">C√©dula de ciudadan√≠a</option>
          <option value="ce">C√©dula de extranjer√≠a</option>
          <option value="nit">NIT</option>
          <option value="pas">Pasaporte</option>
        </select>
      </div>

      <!-- ‚úÖ N√öMERO DE DOCUMENTO con validaci√≥n din√°mica -->
      <div class="campo">
        <label>N√∫mero de Documento del propietario <span class="required">*</span></label>
        <input
          type="text"
          formControlName="documento"
          placeholder="1010101010"
          (input)="onDocumentoInput($event)"
          [class.error]="documentoError"
        />
        <small class="error-message" *ngIf="documentoError">{{ documentoError }}</small>
        
        <!-- ‚ÑπÔ∏è Ayuda contextual seg√∫n tipo de documento -->
        <small class="help-text" *ngIf="!documentoError">
          <span *ngIf="form.get('docTipo')?.value === 'cc'">C√©dula: 6-10 d√≠gitos</span>
          <span *ngIf="form.get('docTipo')?.value === 'ce'">C√©dula de extranjer√≠a: 6-7 d√≠gitos</span>
          <span *ngIf="form.get('docTipo')?.value === 'nit'">NIT: 9-10 d√≠gitos</span>
          <span *ngIf="form.get('docTipo')?.value === 'pas'">Pasaporte: 6-9 caracteres alfanum√©ricos</span>
        </small>
      </div>

      <!-- ‚úÖ Casilla de aceptaci√≥n -->
      <div class="campo campo-checkbox">
        <label class="checkbox-label">
          <input
            type="checkbox"
            formControlName="aceptoDatos"
            required
          />
          He le√≠do y acepto la
          <a
            href="/autorizacion-datos"
            target="_blank"
            rel="noopener noreferrer"
          >
            autorizaci√≥n para tratamiento de datos personales
          </a>.
        </label>
      </div>

      <!-- ‚úÖ Bot√≥n con validaci√≥n y loading -->
      <div class="submit-wrap">
        <button 
          class="btn-consultar" 
          type="submit" 
          [disabled]="!form.valid || consultandoRunt()"
          [class.disabled]="!form.valid || consultandoRunt()"
          [class.loading]="consultandoRunt()"
        >
          <span *ngIf="!consultandoRunt()">
            Consultar <i class="bi bi-search"></i>
          </span>
          <span *ngIf="consultandoRunt()">
            <i class="spinner"></i> Consultando RUNT...
          </span>
        </button>
      </div>
    </form>

    <div class="vehiculos">
      <img src="/assets/peritaje.png" alt="Veh√≠culos" />
    </div>
  </div>
</section>


<!-- ===================== PASO 2 ===================== -->
<section *ngIf="paso() === 2" class="peritaje-paso2">
  <div class="peritaje-grid">

    <!-- Columna izquierda -->
    <div class="peritaje-left">
      <h2 class="title">Peritaje & Aval√∫o</h2>

      <div class="datos">
        <div class="input-duo">
          <div class="campo half">
            <label>N√∫mero de placa</label>
            <input type="text" [value]="form.value.placa?.toUpperCase()" disabled />
          </div>
          <div class="campo half">
            <label>N√∫mero de identidad</label>
            <input type="text" [value]="form.value.documento" disabled />
          </div>
        </div>

        <!-- üÜï DESCRIPCI√ìN DIN√ÅMICA DEL VEH√çCULO -->
        <p class="descripcion" *ngIf="datosRunt()">
          Verificamos que el veh√≠culo <strong>{{ descripcionVehiculo }}</strong> puede realizar estos servicios.
        </p>
        
        <p class="descripcion" *ngIf="!datosRunt()">
          Veh√≠culo <strong>{{ form.value.placa?.toUpperCase() }}</strong>
        </p>
        
        <!-- üÜï MENSAJE SEG√öN CANTIDAD DE PLANES -->
        <p class="descripcion-ayuda" *ngIf="cantidadPlanesDisponibles > 1">
          Consulta los diferentes precios:
        </p>
        
        <p class="descripcion-ayuda" *ngIf="cantidadPlanesDisponibles === 1">
          Este es el √∫nico plan disponible para tu veh√≠culo:
        </p>

        <!-- Botones de plan (solo mostrar los disponibles) -->
        <div class="planes">
          <button
            *ngIf="planesDisponibles.diamante"
            class="plan-btn"
            [class.active]="planActivo() === 'diamante'"
            (click)="cambiarPlan('diamante')">Diamante</button>
          <button
            *ngIf="planesDisponibles.oro"
            class="plan-btn"
            [class.active]="planActivo() === 'oro'"
            (click)="cambiarPlan('oro')">Oro</button>
          <button
            *ngIf="planesDisponibles.plata"
            class="plan-btn"
            [class.active]="planActivo() === 'plata'"
            (click)="cambiarPlan('plata')">Plata</button>
        </div>

        <!-- üÜï PRECIO DIN√ÅMICO -->
        <p class="precio">
          Total: <strong>{{ precioPlan() | currency:'COP':'symbol':'1.0-0' }}</strong>
        </p>

        <!-- Imagen din√°mica -->
        <div class="vehiculo-imagen">
          <img [src]="imagenVehiculo" alt="Veh√≠culo Plan" />
        </div>
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="peritaje-right">
      
      <!-- ====== LIVIANOS ====== -->
      <div class="tab-content" [class.active]="tabCorrecta === 'livianos'">
        <div class="combo-header" [ngClass]="planActivo()">
          <span class="vehiculo-tipo">VEH√çCULOS LIVIANOS</span>
          <h3 class="combo-nombre">
            <ng-container [ngSwitch]="planActivo()">
              <span *ngSwitchCase="'diamante'">Combo Diamante</span>
              <span *ngSwitchCase="'oro'">Combo Oro</span>
              <span *ngSwitchCase="'plata'">Combo Plata</span>
            </ng-container>
          </h3>
        </div>

        <div class="acordeon">
          <details open>
            <summary>Estructura y carrocer√≠a</summary>
            <p>Inspecci√≥n visual detallada, medici√≥n de chasis y componentes estructurales.</p>
          </details>
          <details>
            <summary>Prueba de ruta</summary>
            <p>Evaluaci√≥n en condiciones reales de manejo para detectar ruidos, vibraciones y desempe√±o.</p>
          </details>
          <details>
            <summary>Improntas y antecedentes</summary>
            <p>Consulta de antecedentes, improntas y validaci√≥n con bases oficiales.</p>
          </details>
          <details>
            <summary>Prueba de motor</summary>
            <p>Medici√≥n de compresi√≥n, fugas, desempe√±o y estado de componentes principales.</p>
          </details>
        </div>

        <!-- ‚úÖ Bot√≥n de agendar -->
        <div class="acciones">
          <button class="btn-agendar" (click)="agendarPeritaje()">Agendar mi peritaje</button>
        </div>
      </div>

      <!-- ====== PESADOS ====== -->
      <div class="tab-content" [class.active]="tabCorrecta === 'pesados'">
        <div class="combo-header" [ngClass]="planActivo()">
          <span class="vehiculo-tipo">VEH√çCULOS PESADOS</span>
          <h3 class="combo-nombre">
            <ng-container [ngSwitch]="planActivo()">
              <span *ngSwitchCase="'diamante'">Combo Diamante</span>
              <span *ngSwitchCase="'oro'">Combo Oro</span>
              <span *ngSwitchCase="'plata'">Combo Plata</span>
            </ng-container>
          </h3>
        </div>

        <div class="acordeon">
          <details open>
            <summary>Revisi√≥n de frenos neum√°ticos</summary>
            <p>Chequeo de fugas, l√≠neas de aire, v√°lvulas y tanques.</p>
          </details>
          <details>
            <summary>Estructura de chasis y suspensi√≥n</summary>
            <p>Inspecci√≥n visual con herramientas de medici√≥n profesional.</p>
          </details>
          <details>
            <summary>Prueba de emisiones</summary>
            <p>Control de gases seg√∫n normativa vigente.</p>
          </details>
        </div>

        <!-- ‚úÖ Bot√≥n de agendar -->
        <div class="acciones">
          <button class="btn-agendar" (click)="agendarPeritaje()">Agendar mi peritaje</button>
        </div>
      </div>

      <!-- ====== MOTOS ====== -->
      <div class="tab-content" [class.active]="tabCorrecta === 'motos'">
        <div class="combo-header" [ngClass]="planActivo()">
          <span class="vehiculo-tipo">MOTOCICLETAS</span>
          <h3 class="combo-nombre">
            <ng-container [ngSwitch]="planActivo()">
              <span *ngSwitchCase="'diamante'">Combo Diamante</span>
              <span *ngSwitchCase="'oro'">Combo Oro</span>
              <span *ngSwitchCase="'plata'">Combo Plata</span>
            </ng-container>
          </h3>
        </div>

        <div class="acordeon">
          <details open>
            <summary>Sistema el√©ctrico</summary>
            <p>Comprobaci√≥n de luces, direccionales, arranque y bater√≠a.</p>
          </details>
          <details>
            <summary>Suspensi√≥n y llantas</summary>
            <p>Revisi√≥n de desgaste, presi√≥n y alineaci√≥n de las ruedas.</p>
          </details>
          <details>
            <summary>Prueba en pista</summary>
            <p>Verificaci√≥n de desempe√±o general en ruta controlada.</p>
          </details>
        </div>

        <!-- ‚úÖ Bot√≥n de agendar -->
        <div class="acciones">
          <button class="btn-agendar" (click)="agendarPeritaje()">Agendar mi peritaje</button>
        </div>
      </div>

      <!-- ====== A DOMICILIO ====== -->
      <div class="tab-content" [class.active]="tabCorrecta === 'domicilio'">
        <div class="combo-header" [ngClass]="planActivo()">
          <span class="vehiculo-tipo">PERITAJE A DOMICILIO</span>
          <h3 class="combo-nombre">
            <ng-container [ngSwitch]="planActivo()">
              <span *ngSwitchCase="'diamante'">Combo Diamante</span>
              <span *ngSwitchCase="'oro'">Combo Oro</span>
              <span *ngSwitchCase="'plata'">Combo Plata</span>
            </ng-container>
          </h3>
        </div>

        <div class="acordeon">
          <details open>
            <summary>Inspecci√≥n en tu ubicaci√≥n</summary>
            <p>Nuestro perito se desplaza hasta donde te encuentres para realizar la inspecci√≥n completa.</p>
          </details>
          <details>
            <summary>Flexibilidad horaria</summary>
            <p>Agenda seg√∫n tu disponibilidad, sin necesidad de desplazarte.</p>
          </details>
          <details>
            <summary>Servicio integral</summary>
            <p>Incluye todos los aspectos del plan seleccionado, con la comodidad de tu hogar u oficina.</p>
          </details>
          <details>
            <summary>Informe digital</summary>
            <p>Recibe el informe completo v√≠a email con fotos y detalles de la inspecci√≥n.</p>
          </details>
        </div>

        <!-- ‚úÖ Bot√≥n de agendar -->
        <div class="acciones">
          <button class="btn-agendar" (click)="agendarPeritaje()">Agendar mi peritaje</button>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- ===================== COMPARADOR DE PLANES (OPCIONAL) ===================== -->
<div class="comparador-backdrop" *ngIf="mostrarComparador()">
  <div class="comparador-modal">
    <button class="close-btn" (click)="cerrarComparador()">√ó</button>

    <h2>¬øCu√°l plan se adapta mejor a tu veh√≠culo?</h2>

    <div class="comparador-grid">
      <!-- Combo Diamante -->
      <div class="combo-card diamante">
        <h3>Combo Diamante </h3>
        <p class="precio">{{ precios.diamante | currency:'COP':'symbol':'1.0-0' }}</p>
        <p class="tiempo">Tiempo estimado 60 minutos</p>
        <ul>
          <li>Diagn√≥stico b√°sico <span class="check">‚úîÔ∏è</span></li>
          <li>Prueba de ruta <span class="check">‚úîÔ∏è</span></li>
          <li>Improntas & antecedentes <span class="check">‚úîÔ∏è</span></li>
          <li>Scanner electr√≥nico <span class="check">‚úîÔ∏è</span></li>
          <li>Revisi√≥n estructura <span class="check">‚úîÔ∏è</span></li>
          <li>Entrega virtual <span class="check">‚úîÔ∏è</span></li>
        </ul>

        <button class="btn-select" (click)="cambiarPlan('diamante'); cerrarComparador(true)">Seleccionar este plan</button>
      </div>

      <!-- Combo seleccionado -->
      <div
        class="combo-card"
        [ngClass]="{ oro: planComparado() === 'oro', plata: planComparado() === 'plata' }">

        <h3 *ngIf="planComparado() === 'oro'">Combo Oro </h3>
        <h3 *ngIf="planComparado() === 'plata'">Combo Plata </h3>

        <p class="precio" *ngIf="planComparado() === 'oro'">{{ precios.oro | currency:'COP':'symbol':'1.0-0' }}</p>
        <p class="precio" *ngIf="planComparado() === 'plata'">{{ precios.plata | currency:'COP':'symbol':'1.0-0' }}</p>

        <p class="tiempo" *ngIf="planComparado() === 'oro'">Tiempo estimado 40 minutos</p>
        <p class="tiempo" *ngIf="planComparado() === 'plata'">Tiempo estimado 30 minutos</p>

        <ul>
          <li>Diagn√≥stico b√°sico <span class="check">‚úîÔ∏è</span></li>
          <li>Prueba de ruta <span class="check">‚úîÔ∏è</span></li>
          <li>Improntas & antecedentes <span [class.check]="true" [class.cross]="planComparado() === 'plata'">‚úîÔ∏è</span></li>
          <li>Scanner electr√≥nico <span class="cross">‚úñÔ∏è</span></li>
          <li>Revisi√≥n estructura <span class="check">‚úîÔ∏è</span></li>
          <li>Entrega virtual <span class="cross">‚úñÔ∏è</span></li>
        </ul>

        <button class="btn-select" (click)="cambiarPlan(planComparado()!); cerrarComparador(true)">Seleccionar este plan</button>
      </div>
    </div>
  </div>
</div>

  </div>
</div>