<!-- ========================== -->
<!-- PANTALLA 0: Pedir ubicaci√≥n -->
<!-- ========================== -->
<div class="modal-backdrop" *ngIf="open() && step === 0">
  <div class="modal-container">
    <button class="close-btn" (click)="cerrar()">√ó</button>
    <div class="modal-content text-center">
      <h2 class="modal-title">¬øQuieres ver las Sedes Cercanas a ti?</h2>
      <p class="modal-text">
        Usa tu ubicaci√≥n actual para sugerencias autom√°ticas.
      </p>
      <div class="alert-warning">
        ‚ö†Ô∏è Tu informaci√≥n no ser√° almacenada y puedes cambiarla en cualquier momento.
      </div>
      <div class="buttons">
        <button class="btn btn-outline" (click)="step = 1; cargarCiudades()">
          No, seleccionar manualmente
        </button>
        
        <button 
          class="btn btn-primary" 
          (click)="activarUbicacion()"
          [disabled]="loadingUbicacion"
          [class.loading]="loadingUbicacion"
        >
          <span class="spinner" *ngIf="loadingUbicacion"></span>
          <span *ngIf="!loadingUbicacion">S√≠, activar ubicaci√≥n</span>
          <span *ngIf="loadingUbicacion">Obteniendo ubicaci√≥n...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========================== -->
<!-- PANTALLA 1: Ciudad + sedes (PERITAJE) -->
<!-- ========================== -->
<div class="modal-backdrop" *ngIf="open() && step === 1">
  <div class="modal-container modal-wide">
    <button class="close-btn" (click)="cerrar()">√ó</button>
    <div class="tarifas-grid">
      <!-- üü† COLUMNA IZQUIERDA -->
      <div class="col-izquierda">
        <div class="tarifas-header">
          <h2>
            Selecciona la sede para tu <br />
            <strong>Peritaje Vehicular</strong>
          </h2>
          <p>
            Al seleccionar la ciudad y la sede de tu preferencia te mostraremos el valor del servicio de peritaje.
            <br />
            <span class="naranja">
              *El valor final puede variar seg√∫n el tipo de veh√≠culo y servicios adicionales solicitados.
            </span>
          </p>
        </div>

        <!-- Filtros -->
        <form [formGroup]="filtroForm" class="filtros-form">
          <!-- Ciudad -->
          <div class="campo">
            <label>Ciudad</label>
            <select
              formControlName="ciudad"
              (change)="seleccionarCiudad($any($event.target).value)"
            >
              <option value="">Selecciona una ciudad</option>
              <option *ngFor="let c of ciudades()" [value]="c.id">
                {{ c.name }}
              </option>
            </select>
          </div>

          <!-- üÜï PERITAJE: Mostrar servicio seleccionado - OCULTO -->
          <!-- <div class="servicio-seleccionado" *ngIf="servicioSeleccionado()">
            <div class="badge-servicio">
              <i class="bi bi-check-circle"></i>
              <span>{{ servicioSeleccionado()?.name || 'Servicio seleccionado' }}</span>
            </div>
            <small class="text-muted">
              Servicio pre-seleccionado seg√∫n tu veh√≠culo
            </small>
          </div> -->
        </form>

        <!-- üó∫ MAPA + LISTA DE SEDES -->
        <div class="mapa-sedes">
          <!-- Mapa: por defecto imagen, si hay sede seleccionada muestra iframe -->
          <div class="mapa-mini">
            <ng-container *ngIf="mapaUrl; else mapaEstatico">
              <iframe
                [src]="mapaUrl"
                width="100%"
                height="100%"
                style="border:0;"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </ng-container>
            <ng-template #mapaEstatico>
              <img src="assets/mapa.svg" alt="Mapa de sedes" />
            </ng-template>
          </div>

          <!-- üëá LISTA CON SCROLL -->
          <div class="lista-sedes scrollable">
            <!-- Estado de carga -->
            <p *ngIf="loadingSedes()">Cargando sedes...</p>

            <!-- Sin sedes -->
            <p *ngIf="!loadingSedes() && sedes().length === 0">
              Selecciona una ciudad para ver las sedes disponibles.
            </p>

            <!-- Sedes reales desde el API -->
            <div
              class="sede-item"
              *ngFor="let s of sedes()"
              [class.selected]="sedeSeleccionada?.nombre === s.name"
              (click)="
                elegirSede({
                  nombre: s.name || s.nombre || '',
                  direccion: extraerDireccion(s.description || '') || s.address || s.direccion || '',
                  horario: extraerHorarios(s.description || '') || s.horario || ''
                })
              "
            >
              <div class="sede-info">
                <div class="sede-left">
                  <h4>{{ s.name || s.nombre || 'Sede' }}</h4>
                  <p>
                    {{
                      extraerDireccion(s.description || '') ||
                      s.address ||
                      s.direccion ||
                      ''
                    }}
                  </p>
                  <!-- ‚úÖ Mostrar distancia si est√° disponible -->
                  <p class="distancia" *ngIf="s.distancia">
                    üöó {{ s.distancia | number:'1.1-1' }} km
                  </p>
                </div>
                <div class="sede-right">
                  <span class="dias">Horarios de atenci√≥n</span>
                  <span class="horario">
                    {{
                      extraerHorarios(s.description || '') ||
                      s.horario ||
                      'Horarios disponibles en la sede'
                    }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- üü† COLUMNA DERECHA -->
      <div class="col-derecha">
        <!-- Ciudad seleccionada -->
        <div class="ciudad-ubicacion">
          <i class="bi bi-geo-alt"></i>
          <span>{{ nombreCiudadSeleccionada }}</span>
        </div>

        <!-- Tarifa visible -->
        <div class="tarifa-card">
          <h3>
            {{ nombreCiudadSeleccionada + ' ‚Äì ' + (sedeSeleccionada?.nombre || 'Sede') }}
          </h3>

          <!-- üÜï PERITAJE: Mostrar servicio seleccionado -->
          <p>{{ descripcionServicioSeleccionado }}</p>

          <ng-container *ngIf="valorEstimado; else sinValor">
            <p class="valor">
              <strong>
                {{ precioServicio | currency:'COP':'symbol':'1.0-0' }}
              </strong>
            </p>
            <small>
              El valor final puede variar seg√∫n servicios adicionales.
            </small>
          </ng-container>
          <ng-template #sinValor>
            <p class="valor">
              Selecciona una sede para ver el valor estimado.
            </p>
          </ng-template>

          <button class="btn-outline">Condiciones del Servicio</button>
          <button
            class="btn-primary"
            [disabled]="!puedeAgendar"
            (click)="agendarPeritaje()"
          >
            Agendar mi peritaje
            <i class="bi bi-calendar-event"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================== -->
<!-- PANTALLA 2: Confirmar y agendar peritaje -->
<!-- ========================== -->
<div class="modal-backdrop" *ngIf="open() && step === 2">
  <div class="modal-container modal-final">
    <button class="close-btn" (click)="cerrar()">√ó</button>
    <div class="final-content">
      <div class="final-grid">
        <!-- üü† Columna izquierda -->
        <div class="col-izquierda">
          <h2 class="titulo">¬°Todo listo!</h2>
          <h3 class="subtitulo">Este es el valor de tu peritaje</h3>
          <p class="descripcion">
            Completa tus datos y agenda tu peritaje:
          </p>

          <!-- üïí Fecha + horario -->
          <div class="form-row">
            <div class="campo">
              <label>Fecha de tu peritaje</label>
              <input
                type="date"
                (change)="onFechaChange($event)"
                [value]="fechaSeleccionada ? (fechaSeleccionada | date:'yyyy-MM-dd') : ''"
              />
            </div>
            <div class="campo">
              <label>Horario disponible</label>
              
              <!-- Loading spinner -->
              <div class="horarios-wrapper" *ngIf="loadingHorarios">
                <p class="text-info">‚è≥ Cargando horarios...</p>
              </div>

              <!-- Sin fecha seleccionada -->
              <div class="horarios-wrapper" *ngIf="!fechaSeleccionada && !loadingHorarios">
                <p class="text-muted">Selecciona una fecha para ver los horarios disponibles.</p>
              </div>

              <!-- SELECT de horarios -->
              <select 
                class="form-control"
                [(ngModel)]="franjaSeleccionada"
                [disabled]="!fechaSeleccionada || loadingHorarios || horariosDisponibles.length === 0"
                *ngIf="fechaSeleccionada && !loadingHorarios"
              >
                <option [value]="null" disabled selected>
                  {{ horariosDisponibles.length > 0 ? 'Selecciona un horario' : 'Sin horarios disponibles' }}
                </option>
                <option 
                  *ngFor="let horario of horariosDisponibles" 
                  [value]="horario"
                >
                  {{ horario }}
                </option>
              </select>

              <!-- Mensaje de error -->
              <small class="text-danger" *ngIf="errorHorarios && !loadingHorarios">
                {{ errorHorarios }}
              </small>

              <!-- Mensaje informativo cuando no hay horarios -->
              <small class="text-muted" *ngIf="fechaSeleccionada && !loadingHorarios && horariosDisponibles.length === 0 && !errorHorarios">
                ‚ÑπÔ∏è No hay horarios disponibles para esta fecha. Puedes continuar sin seleccionar horario.
              </small>
            </div>
          </div>

          <!-- üìú CONTENEDOR CON SCROLL -->
          <div class="form-scroll-container">
            <form
              [formGroup]="agendaForm"
              class="form-agendar"
            >
            <div class="form-row">
              <div class="campo">
                <label>N√∫mero de placa</label>
                <input
                  type="text"
                  placeholder="ABC123"
                  formControlName="placa"
                />
              </div>
              <div class="campo">
                <label>Nombre</label>
                <input
                  type="text"
                  placeholder="Nombre completo"
                  formControlName="nombre"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="campo">
                <label>Tel√©fono</label>
                <input
                  type="text"
                  placeholder="321 321 3211"
                  formControlName="telefono"
                />
              </div>
              <div class="campo">
                <label>Correo</label>
                <input
                  type="email"
                  placeholder="correo@gmail.com"
                  formControlName="correo"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="campo">
                <label>Tipo de documento</label>
                <select formControlName="tipoDocumento">
                  <option value="">Selecciona</option>
                  <option value="cc">C√©dula de ciudadan√≠a</option>
                  <option value="ce">C√©dula de extranjer√≠a</option>
                  <option value="nit">NIT</option>
                </select>
              </div>
              <div class="campo">
                <label>Documento</label>
                <input
                  type="text"
                  placeholder="123 123 1234"
                  formControlName="documento"
                />
              </div>
            </div>

            <!-- üÜï PERITAJE: Campos de resultado (solo para A DOMICILIO) -->
            <div class="campo" *ngIf="esServicioADomicilio">
              <label>Direcci√≥n donde se realizar√° el peritaje *</label>
              <input
                type="text"
                placeholder="Calle 123 # 45-67, Barrio, Ciudad"
                formControlName="direccionServicio"
              />
              <small class="text-muted">
                Ingresa la direcci√≥n exacta donde nuestro perito realizar√° la inspecci√≥n
              </small>
            </div>

            <!-- üÜï Campos de entrega de resultado -->
            <div class="form-row">
              <div class="campo">
                <label>Correo electr√≥nico donde enviaremos el resultado del peritaje</label>
                <input
                  type="email"
                  placeholder="Correo electr√≥nico donde enviaremos el resultado del peritaje"
                  formControlName="correoResultado"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="campo">
                <label>Nombre de la persona a quien se le entrega el resultado f√≠sico del peritaje</label>
                <input
                  type="text"
                  placeholder="Nombre de la persona a quien se le entrega el resultado f√≠sico del peritaje"
                  formControlName="nombreResultado"
                />
              </div>
            </div>

            <!-- ‚úÖ Checkbox de autorizaci√≥n de datos -->
            <div class="campo campo-checkbox">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  formControlName="aceptoDatos"
                  required
                />
                He le√≠do y acepto la
                <a                   
                  href="/autorizacion-datos"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  autorizaci√≥n para tratamiento de datos personales
                </a>.
              </label>
            </div>

            <!-- üîÑ Mensaje de error si hay -->
            <div class="alert alert-danger" *ngIf="errorAgendamiento">
              <strong>‚ö†Ô∏è Error:</strong> {{ errorAgendamiento }}
            </div>
            </form>
          </div>
          <!-- FIN CONTENEDOR CON SCROLL -->
        </div>

        <!-- üü† Columna derecha -->
        <div class="col-derecha">
          <div class="tarifa-card resumen">
            <h4>
              {{ nombreCiudadSeleccionada + ' ‚Äì ' + (sedeSeleccionada?.nombre || 'Sede') }}
            </h4>
            <p>{{ descripcionServicioSeleccionado }}</p>
            <div class="valor-total">
              <span class="label">Valor total</span>
              <strong class="monto">
                {{ precioServicio | currency:'COP':'symbol':'1.0-0' }}
              </strong>
            </div>
            <small>
              Este es el valor total para tu peritaje vehicular.
            </small>
            <button class="btn-outline">Condiciones del Servicio</button>
            
            <!-- üî• BOT√ìN DE AGENDAR EN COLUMNA DERECHA -->
            <button
              type="button"
              class="btn-primary btn-agendar-derecha"
              [disabled]="!agendaForm.valid || isAgendando"
              [class.loading]="isAgendando"
              (click)="irAPago()"
            >
              <!-- Spinner cuando est√° cargando -->
              <span class="spinner" *ngIf="isAgendando"></span>
              
              <!-- Texto del bot√≥n -->
              <span *ngIf="!isAgendando">
                Continuar al pago ‚Üí
              </span>
              <span *ngIf="isAgendando">
                Preparando pago...
              </span>
            </button>
          </div>
          <div class="auto-img">
            <img src="assets/vehiculo.png" alt="Veh√≠culo" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>